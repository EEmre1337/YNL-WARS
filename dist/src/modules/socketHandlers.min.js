Object.defineProperty(exports,"__esModule",{value:!0}),exports.setupSocketHandlers=setupSocketHandlers;var _gameState=require("./gameState.js"),_gameConfig=require("./gameConfig.js"),_collisionUtils=require("./collisionUtils.js");function createExplosion(e,a,t,s,o){Object.values(a).forEach(function(e){var a;e.id!==o&&(a=Math.sqrt(Math.pow(e.x-t,2)+Math.pow(e.y-s,2)))<=100&&(a=a<=100/3?3:a<=200/3?2:1,e.health=Math.max(0,e.health-a),e.health<=0)&&(a="red"===e.team?_gameConfig.redSpawn:_gameConfig.blueSpawn,e.x=a.x,e.y=a.y,e.health=2,e.armor=0,e.hasFlag=!1,_gameState.flag.holder===e.id)&&(_gameState.flag.holder=null,_gameState.flag.x=750,_gameState.flag.y=400)}),e.emit("state",{players:a,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits,armors:_gameState.armors})}function setupSocketHandlers(m,o){m.on("connection",function(i){console.log("Neuer Spieler verbunden:",i.id),i.emit("chatUpdate",_gameState.chatMessages),i.emit("updateMedikits",_gameState.medikits),i.emit("updateArmors",_gameState.armors),i.on("chooseTeam",function(e){var e=e||{},a=e.username,t=e.team,e=e.class;a&&t&&e?(_gameState.players[i.id]={x:("red"===t?_gameConfig.redSpawn:_gameConfig.blueSpawn).x,y:("red"===t?_gameConfig.redSpawn:_gameConfig.blueSpawn).y,team:t,username:a,hasFlag:!1,health:2,armor:0,class:e,lastShot:0,hasGrenade:!1,speed:5},console.log("ðŸ“¢ ".concat(a," ist Team ").concat(t.toUpperCase()," als ").concat(_gameConfig.classes[e].name," beigetreten!")),_gameState.chatMessages.push("ðŸ“¢ ".concat(a," ist Team ").concat(t.toUpperCase()," als ").concat(_gameConfig.classes[e].name," beigetreten!")),m.emit("chatUpdate",_gameState.chatMessages),m.emit("state",{players:_gameState.players,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits})):console.error("âŒ Fehler: `username`, `team` oder `class` ist undefined!",{username:a,team:t,playerClass:e})}),i.on("move",function(e){var a,t,s=_gameState.players[i.id];s&&(a=_gameConfig.classes[s.class].speed/3,s.speedBoostActive&&(a*=2),t=s.x+e.dx*a,!(0,_collisionUtils.checkCollision)(t-10,(e=s.y+e.dy*a)-10,20,20,_gameConfig.walls)&&(0,_collisionUtils.checkBorderCollision)(t,e,20,20)&&(s.x=t,s.y=e),handleFlagPickup(i,s),handleFlagCapture(i,s,m),handleMedikitPickup(i,s,m),handleArmorPickup(i,s,m),o.medikits.forEach(function(e){e.active&&Math.abs(s.x-e.x)<30&&Math.abs(s.y-e.y)<30&&(e.active=!1,s.health=Math.min(s.health+50,100),m.emit("updateMedikits",o.medikits))}),o.armors.forEach(function(e){e.active&&Math.abs(s.x-e.x)<30&&Math.abs(s.y-e.y)<30&&(e.active=!1,s.armor=Math.min(s.armor+50,100),m.emit("updateArmors",o.armors))}),o.grenades.forEach(function(e){e.active&&Math.abs(s.x-e.x)<30&&Math.abs(s.y-e.y)<30&&(e.active=!1,s.hasGrenade=!0,m.emit("updateGrenades",o.grenades))}),o.speedBoosters.forEach(function(e){e.active&&Math.abs(s.x-e.x)<30&&Math.abs(s.y-e.y)<30&&(e.active=!1,s.speedBoostActive=!0,setTimeout(function(){_gameState.players[i.id]&&(_gameState.players[i.id].speedBoostActive=!1,m.to(i.id).emit("speedBoostEnded"))},2e4),m.to(i.id).emit("speedBoostActive",2e4),m.emit("updateSpeedBoosters",o.speedBoosters))}),m.emit("state",{players:_gameState.players,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits,armors:_gameState.armors}))}),i.on("chatMessage",function(e){_gameState.players[i.id]&&(e="".concat(_gameState.players[i.id].username,": ").concat(e),_gameState.chatMessages.push(e),m.emit("chatUpdate",_gameState.chatMessages))}),i.on("shoot",function(e){var a=_gameState.players[i.id];if(a){var t=_gameConfig.classes[a.class],s=Date.now();if(!(s-a.lastShot<t.cooldown)){for(var o=0;o<t.projectileCount;o++){var n=t.spread,n=e.angle+(Math.random()-.5)*n;_gameState.projectiles.push({x:a.x,y:a.y,vx:Math.cos(n)*t.projectileSpeed,vy:Math.sin(n)*t.projectileSpeed,owner:i.id,damage:t.damage})}a.lastShot=s,m.emit("state",{players:_gameState.players,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits,armors:_gameState.armors})}}}),i.on("throwGrenade",function(e){var s,a,o,n,r,t=_gameState.players[i.id];t&&t.hasGrenade?(console.log("Granaten-Wurf gestartet:",{playerId:i.id,playerPos:{x:t.x,y:t.y},angle:e.angle,power:e.power}),t.hasGrenade=!1,s="grenade_".concat(Date.now(),"_").concat(Math.random()),a=15*(e.power||1),o={id:s,x:t.x,y:t.y,dx:Math.cos(e.angle)*a,dy:Math.sin(e.angle)*a,throwerId:i.id},m.emit("updateGrenadePosition",{id:s,x:o.x,y:o.y}),n=0,r=setInterval(function(){o.x+=o.dx,o.y+=o.dy,o.dy+=.5,o.dx*=.98,m.emit("updateGrenadePosition",{id:s,x:o.x,y:o.y});var t,a=!1;_gameConfig.walls.forEach(function(e){!a&&o.x>=e.x&&o.x<=e.x+e.width&&o.y>=e.y&&o.y<=e.y+e.height&&(a=!0)}),((a=!a&&(o.x<0||1600<o.x||o.y<0||1200<o.y)?!0:a)||30<=n)&&(clearInterval(r),t={id:s,x:o.x,y:o.y},m.emit("grenadeDropped",t),setTimeout(function(){Object.values(_gameState.players).forEach(function(e){var a;e.id!==o.throwerId&&(a=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)))<=100&&(a=Math.floor(3*(1-a/100)),e.health=Math.max(0,e.health-a),e.health<=0)&&(a="red"===e.team?_gameConfig.redSpawn:_gameConfig.blueSpawn,e.x=a.x,e.y=a.y,e.health=100,e.armor=0)}),m.emit("grenadeExplosion",t),m.emit("state",{players:_gameState.players,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits,armors:_gameState.armors})},1e3)),n++},50)):console.log("Granaten-Wurf fehlgeschlagen:",{playerExists:!!t,hasGrenade:null==t?void 0:t.hasGrenade})}),i.on("spawn",function(e){var a=e.username,t=e.team,s="red"===t?_gameConfig.redSpawn:_gameConfig.blueSpawn;_gameState.players[i.id]={id:i.id,x:s.x,y:s.y,team:t,username:a,health:100,armor:0,class:e.playerClass,lastShot:0,hasGrenade:!1,speed:5,speedBoostActive:!1},m.emit("playerJoined",{id:i.id,username:a,team:t})}),i.on("disconnect",function(){var e;_gameState.players[i.id]&&(e="âŒ ".concat(_gameState.players[i.id].username," hat das Spiel verlassen."),_gameState.chatMessages.push(e),m.emit("chatUpdate",_gameState.chatMessages),delete _gameState.players[i.id]),console.log("Spieler getrennt:",i.id),m.emit("state",{players:_gameState.players,projectiles:_gameState.projectiles,walls:_gameConfig.walls,flag:_gameState.flag,score:_gameState.score,redSpawn:_gameConfig.redSpawn,blueSpawn:_gameConfig.blueSpawn,medikits:_gameState.medikits,armors:_gameState.armors})})})}function handleFlagPickup(e,a){!_gameState.flag.holder&&Math.abs(a.x-_gameState.flag.x)<20&&Math.abs(a.y-_gameState.flag.y)<20&&(_gameState.flag.holder=e.id,a.hasFlag=!0,console.log("ðŸš© ".concat(a.username," hat die Flagge aufgenommen!")),e.emit("chatMessage","ðŸš© ".concat(a.username," hat die Flagge aufgenommen!")))}function handleFlagCapture(e,a,t){var s="red"===a.team?_gameConfig.redSpawn:_gameConfig.blueSpawn;a.hasFlag&&a.x>s.x&&a.x<s.x+s.width&&a.y>s.y&&a.y<s.y+s.height&&(_gameState.score[a.team]++,console.log("ðŸ† Punkt fÃ¼r Team ".concat(a.team.toUpperCase())),_gameState.flag.x=750,_gameState.flag.y=400,_gameState.flag.holder=null,a.hasFlag=!1,t.emit("chatMessage","ðŸŽ‰ ".concat(a.username," hat einen Punkt fÃ¼r Team ").concat(a.team.toUpperCase()," erzielt!")),3===_gameState.score[a.team])&&(t.emit("gameOver",a.team),_gameState.score.red=0,_gameState.score.blue=0)}function handleMedikitPickup(e,a,t){_gameState.medikits.forEach(function(e){e.active&&Math.abs(a.x-e.x)<10&&Math.abs(a.y-e.y)<10&&(a.health<2&&(a.health=2,console.log("â¤ï¸ ".concat(a.username," hat sich geheilt!")),t.emit("chatMessage","â¤ï¸ ".concat(a.username," hat sich geheilt!"))),e.active=!1,t.emit("updateMedikits",_gameState.medikits))})}function handleArmorPickup(e,a,t){_gameState.armors.forEach(function(e){e.active&&Math.abs(a.x-e.x)<10&&Math.abs(a.y-e.y)<10&&(0===a.armor&&(a.armor=1,console.log("ðŸ›¡ ".concat(a.username," hat RÃ¼stung aufgenommen!")),t.emit("chatMessage","ðŸ›¡ ".concat(a.username," hat RÃ¼stung aufgenommen!"))),e.active=!1,t.emit("updateArmors",_gameState.armors))})}
//# sourceMappingURL=socketHandlers.min.js.map
